<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Dashboard - Sentinel</title>
    <style>
        body { font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; background: #f9fafb; color: #1f2937; margin: 0; }
        .container { max-width: 1200px; margin: 2rem auto; padding: 2rem; }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e5e7eb; padding-bottom: 1rem; }
        .header-left { display: flex; align-items: center; gap: 1.5rem; }
        .main-content { display: flex; gap: 2rem; margin-top: 2rem; }
        .sidebar { width: 25%; flex-shrink: 0; }
        .dashboard-area { width: 75%; }
        h1, h2, h3 { color: #111827; }
        h1 { font-size: 1.875rem; }
        h2 { font-size: 1.25rem; }
        a { color: #4f46e5; text-decoration: none; }
        .card { background: white; padding: 1.5rem; border-radius: 0.75rem; box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1), 0 1px 2px 0 rgba(0,0,0,0.06); margin-bottom: 1.5rem; }
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1.5rem; }
        .stat-card h3 { margin: 0; font-size: 1rem; color: #6b7280; font-weight: 500; }
        .stat-card p { margin: 0.5rem 0 0; font-size: 2.25rem; font-weight: bold; }
        .tables-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem; margin-top: 2rem; }
        .details-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; margin-top: 2rem; }
        table { width: 100%; border-collapse: collapse; }
        th, td { text-align: left; padding: 0.75rem 1rem; border-bottom: 1px solid #e5e7eb; max-width: 250px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .sites-list { padding: 0; margin: 0; }
        .sites-list li { list-style: none; padding: 0.75rem; cursor: pointer; border-radius: 0.375rem; margin-bottom: 0.25rem; }
        .sites-list li:hover { background-color: #f3f4f6; }
        .sites-list li.active { background-color: #e5e7eb; font-weight: 600; }
        form label { font-size: 0.875rem; font-weight: 500; color: #374151; }
        form input[type="text"] { width: calc(100% - 1.2rem); padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; margin-top: 0.25rem;}
        form input[type="submit"] { display: block; width: 100%; padding: 0.6rem; border: none; border-radius: 0.375rem; background: #111827; color: white; font-weight: 600; cursor: pointer; margin-top: 1rem; }
        .snippet-wrapper { position: relative; }
        pre { background: #f3f4f6; padding: 1rem; border-radius: 0.375rem; white-space: pre-wrap; word-break: break-all; font-size: 0.875rem; }
        .copy-btn { position: absolute; top: 0.5rem; right: 0.5rem; background: #d1d5db; border: none; padding: 0.25rem 0.5rem; border-radius: 0.25rem; cursor: pointer; font-size: 0.75rem; }
        select { padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; }
        .hidden { display: none; }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <div class="header-left">
                <h1>Sentinel</h1>
                <div id="date-filter-container" class="hidden">
                    <select id="date-filter">
                        <option value="1">Last 24 Hours</option>
                        <option value="7">Last 7 Days</option>
                        <option value="30">Last 30 Days</option>
                    </select>
                </div>
            </div>
            <a href="/logout">Logout</a>
        </div>

        <div class="main-content">
            <div class="sidebar">
                <div class="card">
                    <h2>Your Sites</h2>
                    <ul id="sites-list" class="sites-list"></ul>
                </div>
                <div class="card">
                    <h2>Add a New Site</h2>
                    <form id="add-site-form">
                        <label for="name">Site Name:</label>
                        <input type="text" id="name" name="name" required placeholder="My Awesome Blog">
                        <input type="submit" value="Add Site">
                    </form>
                </div>
            </div>

            <div class="dashboard-area">
                <div id="dashboard-view" class="hidden">
                    <h2 id="current-site-name"></h2>
                    <div class="card">
                        <h3>Tracking Snippet</h3>
                        <p>Add this code anywhere in your website's HTML file.</p>
                        <div class="snippet-wrapper">
                            <pre><code id="tracking-snippet"></code></pre>
                            <button class="copy-btn" id="copy-btn">Copy</button>
                        </div>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3>Total Views</h3>
                            <p id="total-views">0</p>
                        </div>
                        <div class="stat-card">
                            <h3>Unique Visitors</h3>
                            <p id="unique-visitors">0</p>
                        </div>
                        <div class="stat-card">
                            <h3>Bounce Rate</h3>
                            <p id="bounce-rate">0%</p>
                        </div>
                        <div class="stat-card">
                            <h3>Avg. Visit Time</h3>
                            <p id="avg-duration">0s</p>
                        </div>
                    </div>

                    <div class="tables-grid">
                        <div class="card">
                            <h2>Top Pages</h2>
                            <table id="top-pages-table">
                                <thead><tr><th>Page</th><th>Views</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        <div class="card">
                            <h2>Top Referrers</h2>
                            <table id="top-referrers-table">
                                <thead><tr><th>Referrer</th><th>Views</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>

                    <div class="details-grid">
                        <div class="card">
                            <h2>Top Browsers</h2>
                            <table id="top-browsers-table">
                                <thead><tr><th>Browser</th><th>Views</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        <div class="card">
                            <h2>Top OS</h2>
                            <table id="top-os-table">
                                <thead><tr><th>Operating System</th><th>Views</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        <div class="card">
                            <h2>Top Countries</h2>
                            <table id="top-countries-table">
                                <thead><tr><th>Country</th><th>Views</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div id="no-site-view">
                    <div class="card">
                        <h2>Welcome to Sentinel!</h2>
                        <p>Add your first site on the left to get started.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const sitesList = document.getElementById('sites-list');
            const addSiteForm = document.getElementById('add-site-form');
            const dashboardView = document.getElementById('dashboard-view');
            const noSiteView = document.getElementById('no-site-view');
            const currentSiteName = document.getElementById('current-site-name');
            const trackingSnippet = document.getElementById('tracking-snippet');
            const copyBtn = document.getElementById('copy-btn');
            const dateFilter = document.getElementById('date-filter');
            const dateFilterContainer = document.getElementById('date-filter-container');

            let currentSiteId = null;
            let dashboardInterval = null;

            async function fetchSites() {
                try {
                    const response = await fetch('/api/sites');
                    const sites = await response.json();
                    sitesList.innerHTML = '';
                    if (sites && sites.length > 0) {
                        dateFilterContainer.classList.remove('hidden');
                        sites.forEach(site => {
                            const li = document.createElement('li');
                            li.textContent = site.name;
                            li.dataset.siteId = site.id;
                            li.addEventListener('click', () => selectSite(site));
                            sitesList.appendChild(li);
                        });
                        if (!currentSiteId) {
                           selectSite(sites[0]);
                        }
                    } else {
                        dashboardView.classList.add('hidden');
                        noSiteView.classList.remove('hidden');
                        dateFilterContainer.classList.add('hidden');
                    }
                } catch (error) {
                    console.error('Failed to fetch sites:', error);
                }
            }

            async function selectSite(site) {
                currentSiteId = site.id;
                document.querySelectorAll('#sites-list li').forEach(li => li.classList.remove('active'));
                document.querySelector(`li[data-site-id="${site.id}"]`).classList.add('active');
                
                dashboardView.classList.remove('hidden');
                noSiteView.classList.add('hidden');

                currentSiteName.textContent = `Dashboard for ${site.name}`;
                trackingSnippet.textContent = `<script src="http://127.0.0.1:8000/static/tracker-v3.js" data-site-id="${site.id}"><\/script>`;
                
                if (dashboardInterval) clearInterval(dashboardInterval);
                await fetchDashboardStats();
                dashboardInterval = setInterval(fetchDashboardStats, 5000);
            }

            function updateTable(tableId, data, defaultValue = 'Unknown') {
                const tableBody = document.querySelector(`#${tableId} tbody`);
                tableBody.innerHTML = '';
                if (data && data.length > 0) {
                    data.forEach(item => {
                        const row = tableBody.insertRow();
                        const value = item.value || defaultValue;
                        row.innerHTML = `<td title="${value}">${value}</td><td>${item.count}</td>`;
                    });
                }
            }

            async function fetchDashboardStats() {
                if (!currentSiteId) return;
                const days = dateFilter.value;
                try {
                    const response = await fetch(`/api/dashboard?siteId=${currentSiteId}&days=${days}`);
                    const stats = await response.json();

                    document.getElementById('total-views').textContent = stats.totalViews || 0;
                    document.getElementById('unique-visitors').textContent = stats.uniqueVisitors || 0;
                    document.getElementById('bounce-rate').textContent = `${stats.bounceRate || 0}%`;
                    document.getElementById('avg-duration').textContent = stats.avgVisitDuration || '0s';
                    
                    updateTable('top-pages-table', stats.topPages);
                    updateTable('top-referrers-table', stats.topReferrers, 'Direct');
                    updateTable('top-browsers-table', stats.topBrowsers);
                    updateTable('top-os-table', stats.topOS);
                    updateTable('top-countries-table', stats.topCountries);

                } catch (error) {
                    console.error('Failed to load dashboard stats:', error);
                }
            }

            addSiteForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const siteNameInput = e.target.name;
                const siteName = siteNameInput.value;
                if (!siteName) return;
                try {
                    const response = await fetch('/api/sites/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name: siteName, domain: '' })
                    });
                    if (!response.ok) throw new Error('Failed to add site');
                    const newSite = await response.json();
                    siteNameInput.value = '';
                    await fetchSites();
                    selectSite(newSite);
                } catch (error) {
                    console.error('Failed to add site:', error);
                }
            });

            copyBtn.addEventListener('click', () => {
                navigator.clipboard.writeText(trackingSnippet.textContent).then(() => {
                    copyBtn.textContent = 'Copied!';
                    setTimeout(() => { copyBtn.textContent = 'Copy'; }, 2000);
                });
            });

            dateFilter.addEventListener('change', fetchDashboardStats);
            fetchSites();
        });
    </script>
</body>
</html>

